# WAF 反向代理配置说明

## 架构说明

本配置将前端容器端口绑定到 `127.0.0.1:3000`，仅允许本地访问。外部请求通过 WAF 的 Nginx 反向代理访问。

```
外网请求
  │
  ▼
[WAF Nginx] (监听 80/443)
  │
  ▼
[127.0.0.1:3000] ← Docker 前端容器（仅本地访问）
  │
  ├─→ [后端容器] (内部网络)
  │     │
  │     └─→ [数据库容器] (内部网络)
  │
  └─→ 所有容器在同一网络: app-network
```

## Docker 配置

前端容器端口已配置为仅绑定到 localhost：

```yaml
ports:
  - "127.0.0.1:${FRONTEND_PORT:-3000}:80"
```

这意味着：
- ✅ 只有本机（localhost）可以访问 `127.0.0.1:3000`
- ✅ 外部无法直接访问前端容器
- ✅ WAF 的 Nginx 可以通过 `127.0.0.1:3000` 访问前端

## WAF Nginx 配置

### 1. 基本配置

参考 `waf-nginx-example.conf` 文件，将配置添加到您的 WAF Nginx 配置中。

### 2. 关键配置项

```nginx
# 代理到 Docker 前端容器
location / {
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

### 3. SSL/TLS 配置

WAF 通常会自动处理 SSL 证书和配置，您只需要：
- 配置域名
- 确保证书有效
- WAF 会自动添加安全头

### 4. WAF 规则

根据您的 WAF 产品，配置以下规则：
- **DDoS 防护**：限制请求频率
- **SQL 注入防护**：检测恶意 SQL
- **XSS 防护**：检测跨站脚本攻击
- **CSRF 防护**：验证请求来源
- **IP 白名单/黑名单**：限制访问来源

## 安全优势

1. **多层防护**：
   - WAF 层：处理 SSL、安全头、攻击检测
   - Docker 网络层：容器间隔离
   - 应用层：JWT 认证、权限控制

2. **端口隔离**：
   - 数据库：完全不暴露
   - 后端：完全不暴露
   - 前端：仅 localhost 访问

3. **统一入口**：
   - 所有请求通过 WAF
   - 统一的安全策略
   - 统一的日志记录

## 部署步骤

### 1. 启动 Docker 容器

```bash
docker-compose up -d --build
```

### 2. 验证前端容器

```bash
# 检查容器是否运行
docker-compose ps

# 测试本地访问（应该可以访问）
curl http://127.0.0.1:3000

# 测试外部访问（应该无法访问，如果 WAF 未配置）
# curl http://your-server-ip:3000  # 应该失败
```

### 3. 配置 WAF Nginx

1. 将 `waf-nginx-example.conf` 中的配置添加到您的 WAF Nginx 配置
2. 修改域名：将 `your-domain.com` 替换为您的实际域名
3. 确保 SSL 证书配置正确
4. 配置 WAF 规则（根据您的 WAF 产品）

### 4. 测试访问

```bash
# 通过域名访问（应该通过 WAF）
curl https://your-domain.com

# 检查日志
tail -f /var/log/nginx/mnr-crawler-access.log
```

## 常见问题

### Q: 为什么前端容器绑定到 127.0.0.1？

A: 这样只有本机可以访问，外部无法直接访问。WAF 的 Nginx 运行在主机上，可以通过 localhost 访问。

### Q: 如何直接访问后端 API？

A: 不推荐直接暴露后端。如果需要，可以：
1. 临时暴露后端端口（仅用于调试）
2. 通过前端容器的 Nginx 代理访问后端
3. 使用 VPN 或内网访问

### Q: WAF 和前端容器的 Nginx 有什么区别？

A:
- **WAF Nginx**：处理 SSL、安全头、WAF 规则、DDoS 防护等
- **前端容器 Nginx**：处理静态资源、SPA 路由、API 代理到后端

### Q: 如何查看容器日志？

A:
```bash
# 查看所有容器日志
docker-compose logs -f

# 查看特定容器日志
docker-compose logs -f frontend
docker-compose logs -f backend
docker-compose logs -f db
```

## 端口说明

| 服务 | 容器端口 | 主机绑定 | 说明 |
|------|---------|---------|------|
| 前端 | 80 | 127.0.0.1:3000 | 仅本地访问，供 WAF 使用 |
| 后端 | 8000 | 不暴露 | 仅内部网络访问 |
| 数据库 | 5432 | 不暴露 | 仅内部网络访问 |

## 网络架构

```
┌─────────────────────────────────────────┐
│           外网用户                        │
└──────────────┬──────────────────────────┘
               │ HTTPS (443)
               ▼
┌─────────────────────────────────────────┐
│        WAF Nginx (主机)                  │
│  - SSL/TLS 终止                          │
│  - 安全头添加                            │
│  - WAF 规则检测                          │
│  - DDoS 防护                             │
└──────────────┬──────────────────────────┘
               │ HTTP (127.0.0.1:3000)
               ▼
┌─────────────────────────────────────────┐
│    Docker 网络 (app-network)            │
│                                          │
│  ┌──────────────┐                       │
│  │ 前端容器      │                       │
│  │ :80          │                       │
│  └──────┬───────┘                       │
│         │                                │
│         ├─→ ┌──────────────┐            │
│         │   │ 后端容器      │            │
│         │   │ :8000        │            │
│         │   └──────┬───────┘            │
│         │          │                     │
│         │          └─→ ┌──────────────┐│
│         │              │ 数据库容器    ││
│         │              │ :5432        ││
│         │              └──────────────┘│
│         │                                │
│         └─→ 静态资源服务                 │
└─────────────────────────────────────────┘
```

## 注意事项

1. **防火墙配置**：确保 WAF 的端口（80/443）已开放，但 Docker 容器的端口（3000）不应对外开放
2. **SSL 证书**：确保 WAF 的 SSL 证书有效且配置正确
3. **日志监控**：定期检查 WAF 和容器日志，及时发现异常
4. **备份策略**：定期备份数据库和配置文件
5. **更新维护**：定期更新 Docker 镜像和 WAF 规则

---

**最后更新**: 2025-12-10

