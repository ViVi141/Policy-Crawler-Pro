name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        service:
          - name: backend
            context: ./backend
            dockerfile: ./backend/Dockerfile
            target: production
          - name: frontend
            context: ./frontend
            dockerfile: ./frontend/Dockerfile
            target: ''
          - name: db
            context: ./database
            dockerfile: ./database/Dockerfile
            target: ''

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/mnr-law-crawler-online-${{ matrix.service.name }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image (with target)
        if: matrix.service.target != ''
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.service.context }}
          file: ${{ matrix.service.dockerfile }}
          target: ${{ matrix.service.target }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Build and push Docker image (without target)
        if: matrix.service.target == ''
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.service.context }}
          file: ${{ matrix.service.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    needs: build-and-push

    services:
      postgres:
        image: postgres:18-alpine
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Wait for database
        run: |
          echo "ç­‰å¾…æ•°æ®åº“å°±ç»ª..."
          timeout 60 bash -c 'until pg_isready -h localhost -p 5432 -U test_user; do sleep 2; done' || exit 1
          echo "æ•°æ®åº“å·²å°±ç»ª"

      - name: Run database migrations
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          JWT_SECRET_KEY: test-secret-key-for-ci
        run: |
          # è¿è¡Œæ•°æ®åº“è¿ç§»
          if [ -d "migrations" ]; then
            pip install alembic
            alembic upgrade head || echo "è¿ç§»å¤±è´¥æˆ–æ— éœ€è¿ç§»"
          else
            echo "æœªæ‰¾åˆ°è¿ç§»ç›®å½•ï¼Œè·³è¿‡è¿ç§»"
          fi

      - name: Run tests
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          JWT_SECRET_KEY: test-secret-key-for-ci
          PYTHONPATH: .
        run: |
          # å¦‚æžœæœ‰æµ‹è¯•æ–‡ä»¶ï¼Œè¿è¡Œæµ‹è¯•
          if [ -f "pytest.ini" ] || [ -d "tests" ]; then
            pip install pytest pytest-asyncio httpx
            pytest -v --tb=short || echo "æµ‹è¯•å¤±è´¥æˆ–æœªæ‰¾åˆ°æµ‹è¯•"
          else
            echo "æœªæ‰¾åˆ°æµ‹è¯•æ–‡ä»¶ï¼Œè·³è¿‡æµ‹è¯•"
            # è‡³å°‘éªŒè¯åº”ç”¨å¯ä»¥å¯¼å…¥
            python -c "from app.main import app; print('âœ… åº”ç”¨å¯ä»¥æ­£å¸¸å¯¼å…¥')" || exit 1
          fi

      - name: Check code quality
        working-directory: ./backend
        run: |
          echo "=== ä»£ç è´¨é‡æ£€æŸ¥ ==="
          pip install flake8 black mypy || true
          
          # ä»£ç æ ¼å¼æ£€æŸ¥ï¼ˆä¸å¼ºåˆ¶å¤±è´¥ï¼‰
          echo "æ£€æŸ¥ä»£ç æ ¼å¼..."
          black --check . || echo "âš ï¸ ä»£ç æ ¼å¼æ£€æŸ¥è·³è¿‡ï¼ˆéžé˜»å¡žï¼‰"
          
          # è¯­æ³•é”™è¯¯æ£€æŸ¥ï¼ˆå¼ºåˆ¶ï¼‰
          echo "æ£€æŸ¥è¯­æ³•é”™è¯¯..."
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --max-line-length=120 || echo "âš ï¸ è¯­æ³•æ£€æŸ¥è·³è¿‡ï¼ˆéžé˜»å¡žï¼‰"
          
          # ç±»åž‹æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰
          echo "æ£€æŸ¥ç±»åž‹æ³¨è§£..."
          mypy app --ignore-missing-imports --no-strict-optional || echo "âš ï¸ ç±»åž‹æ£€æŸ¥è·³è¿‡ï¼ˆéžé˜»å¡žï¼‰"
          
          echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆ"

  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: |
          npm ci --legacy-peer-deps || \
          (echo "npm ci å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ npm install..." && npm install --legacy-peer-deps)

      - name: Run linter
        working-directory: ./frontend
        run: |
          npm run lint || echo "Linting check skipped"

      - name: Build frontend
        working-directory: ./frontend
        env:
          VITE_API_BASE_URL: /api  # ç”Ÿäº§çŽ¯å¢ƒä½¿ç”¨ç›¸å¯¹è·¯å¾„
        run: |
          echo "=== æž„å»ºå‰ç«¯åº”ç”¨ ==="
          npm run build
          
          # éªŒè¯æž„å»ºäº§ç‰©
          if [ -d "dist" ]; then
            echo "âœ… æž„å»ºæˆåŠŸï¼Œdist ç›®å½•å·²åˆ›å»º"
            ls -lah dist/ | head -10
          else
            echo "âŒ æž„å»ºå¤±è´¥ï¼Œdist ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶
          [ -f "dist/index.html" ] || (echo "âŒ index.html ä¸å­˜åœ¨" && exit 1)
          echo "âœ… æž„å»ºéªŒè¯é€šè¿‡"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      contents: read
      security-events: write
      actions: read
      packages: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # ä¸é˜»å¡žæž„å»ºï¼Œä»…æŠ¥å‘Š

      - name: Determine image tags
        id: image-tags
        run: |
          # æ ¹æ®äº‹ä»¶ç±»åž‹ç¡®å®šå¯èƒ½çš„é•œåƒæ ‡ç­¾
          TAGS=""
          
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            TAGS="pr-${{ github.event.pull_request.number }} pr-${{ github.event.pull_request.number }}-${{ github.sha }}"
          elif [ "${{ github.event_name }}" == "release" ]; then
            TAGS="${{ github.event.release.tag_name }} latest"
          elif [ "${{ github.ref }}" == "refs/heads/main" ] || [ "${{ github.ref }}" == "refs/heads/master" ]; then
            TAGS="latest main-${{ github.sha }} master-${{ github.sha }}"
          else
            BRANCH_NAME=$(echo "${{ github.ref }}" | sed 's/refs\/heads\///' | sed 's/\//-/g')
            TAGS="${BRANCH_NAME} ${BRANCH_NAME}-${{ github.sha }}"
          fi
          
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "å¯èƒ½çš„é•œåƒæ ‡ç­¾: ${TAGS}"

      - name: Check if backend image exists
        id: check-backend-image
        continue-on-error: true
        run: |
          # å°è¯•å¤šä¸ªå¯èƒ½çš„æ ‡ç­¾
          TAGS='${{ steps.image-tags.outputs.tags }}'
          BASE_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/mnr-law-crawler-online-backend"
          
          echo "å°è¯•æŸ¥æ‰¾åŽç«¯é•œåƒ..."
          FOUND_IMAGE=""
          FOUND_TAG=""
          
          # éåŽ†æ ‡ç­¾åˆ—è¡¨
          for TAG in ${TAGS}; do
            IMAGE_NAME="${BASE_IMAGE}:${TAG}"
            echo "æ£€æŸ¥: ${IMAGE_NAME}"
            
            if docker manifest inspect "${IMAGE_NAME}" >/dev/null 2>&1; then
              FOUND_IMAGE="${IMAGE_NAME}"
              FOUND_TAG="${TAG}"
              echo "âœ… æ‰¾åˆ°é•œåƒ: ${IMAGE_NAME}"
              break
            fi
          done
          
          if [ -n "${FOUND_IMAGE}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "image=${FOUND_IMAGE}" >> $GITHUB_OUTPUT
            echo "tag=${FOUND_TAG}" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ æœªæ‰¾åˆ°åŽç«¯é•œåƒï¼Œè·³è¿‡æ‰«æ"
            echo "å°è¯•çš„æ ‡ç­¾: ${TAGS}"
          fi

      - name: Scan backend Docker image
        if: steps.check-backend-image.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.check-backend-image.outputs.image }}
          format: 'sarif'
          output: 'trivy-backend-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Check if frontend image exists
        id: check-frontend-image
        continue-on-error: true
        run: |
          # å°è¯•å¤šä¸ªå¯èƒ½çš„æ ‡ç­¾
          TAGS='${{ steps.image-tags.outputs.tags }}'
          BASE_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/mnr-law-crawler-online-frontend"
          
          echo "å°è¯•æŸ¥æ‰¾å‰ç«¯é•œåƒ..."
          FOUND_IMAGE=""
          FOUND_TAG=""
          
          # éåŽ†æ ‡ç­¾åˆ—è¡¨
          for TAG in ${TAGS}; do
            IMAGE_NAME="${BASE_IMAGE}:${TAG}"
            echo "æ£€æŸ¥: ${IMAGE_NAME}"
            
            if docker manifest inspect "${IMAGE_NAME}" >/dev/null 2>&1; then
              FOUND_IMAGE="${IMAGE_NAME}"
              FOUND_TAG="${TAG}"
              echo "âœ… æ‰¾åˆ°å‰ç«¯é•œåƒ: ${IMAGE_NAME}"
              break
            fi
          done
          
          if [ -n "${FOUND_IMAGE}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "image=${FOUND_IMAGE}" >> $GITHUB_OUTPUT
            echo "tag=${FOUND_TAG}" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ æœªæ‰¾åˆ°å‰ç«¯é•œåƒï¼Œè·³è¿‡æ‰«æ"
          fi

      - name: Scan frontend Docker image
        if: steps.check-frontend-image.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.check-frontend-image.outputs.image }}
          format: 'sarif'
          output: 'trivy-frontend-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Upload Trivy filesystem results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-fs-results.sarif'

      - name: Upload Trivy backend image results
        uses: github/codeql-action/upload-sarif@v4
        if: always() && steps.check-backend-image.outputs.exists == 'true'
        with:
          sarif_file: 'trivy-backend-results.sarif'

      - name: Upload Trivy frontend image results
        uses: github/codeql-action/upload-sarif@v4
        if: always() && steps.check-frontend-image.outputs.exists == 'true'
        with:
          sarif_file: 'trivy-frontend-results.sarif'

      - name: Security scan summary
        if: always()
        run: |
          echo "=== å®‰å…¨æ‰«ææ‘˜è¦ ==="
          echo ""
          
          if [ -f "trivy-fs-results.sarif" ]; then
            echo "âœ… æ–‡ä»¶ç³»ç»Ÿæ‰«æå®Œæˆ"
          else
            echo "âš ï¸ æ–‡ä»¶ç³»ç»Ÿæ‰«ææœªå®Œæˆ"
          fi
          
          if [ -f "trivy-backend-results.sarif" ]; then
            echo "âœ… åŽç«¯ Docker é•œåƒæ‰«æå®Œæˆ"
          else
            echo "âš ï¸ åŽç«¯é•œåƒæ‰«ææœªå®Œæˆï¼ˆé•œåƒå¯èƒ½ä¸å­˜åœ¨æˆ–ä½¿ç”¨ä¸åŒæ ‡ç­¾ï¼‰"
          fi
          
          if [ -f "trivy-frontend-results.sarif" ]; then
            echo "âœ… å‰ç«¯ Docker é•œåƒæ‰«æå®Œæˆ"
          else
            echo "âš ï¸ å‰ç«¯é•œåƒæ‰«ææœªå®Œæˆï¼ˆé•œåƒå¯èƒ½ä¸å­˜åœ¨æˆ–ä½¿ç”¨ä¸åŒæ ‡ç­¾ï¼‰"
          fi
          
          echo ""
          echo "è¯¦ç»†ç»“æžœå·²ä¸Šä¼ åˆ° GitHub Securityï¼ˆå¦‚æžœå¯ç”¨ï¼‰"

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-and-push, test-backend, test-frontend]
    if: github.event_name == 'release' && github.event.action == 'published'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Generate release notes
        id: release_notes
        run: |
          echo "## ðŸ³ Docker Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ä»¥ä¸‹é•œåƒå·²æž„å»ºå¹¶æŽ¨é€åˆ° GitHub Container Registry:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/mnr-law-crawler-online-backend:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/mnr-law-crawler-online-frontend:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/mnr-law-crawler-online-db:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ ä½¿ç”¨æ–¹å¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# æ‹‰å–é•œåƒ" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/mnr-law-crawler-online-backend:latest" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/mnr-law-crawler-online-frontend:latest" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/mnr-law-crawler-online-db:latest" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
