name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}

jobs:
  build-and-push:
    name: Build and Push Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        service:
          - name: backend
            context: ./backend
            dockerfile: ./backend/Dockerfile
            target: production
          - name: frontend
            context: ./frontend
            dockerfile: ./frontend/Dockerfile
            target: ''
          - name: db
            context: ./database
            dockerfile: ./database/Dockerfile
            target: ''

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/mnr-law-crawler-online-${{ matrix.service.name }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image (with target)
        if: matrix.service.target != ''
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.service.context }}
          file: ${{ matrix.service.dockerfile }}
          target: ${{ matrix.service.target }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Build and push Docker image (without target)
        if: matrix.service.target == ''
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.service.context }}
          file: ${{ matrix.service.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    needs: build-and-push

    services:
      postgres:
        image: postgres:18-alpine
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache pip packages
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('backend/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        working-directory: ./backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Wait for database
        run: |
          echo "ç­‰å¾…æ•°æ®åº“å°±ç»ª..."
          timeout 60 bash -c 'until pg_isready -h localhost -p 5432 -U test_user; do sleep 2; done' || exit 1
          echo "æ•°æ®åº“å·²å°±ç»ª"

      - name: Run database migrations
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          JWT_SECRET_KEY: test-secret-key-for-ci
        run: |
          # è¿è¡Œæ•°æ®åº“è¿ç§»
          if [ -d "migrations" ]; then
            pip install alembic
            alembic upgrade head || echo "è¿ç§»å¤±è´¥æˆ–æ— éœ€è¿ç§»"
          else
            echo "æœªæ‰¾åˆ°è¿ç§»ç›®å½•ï¼Œè·³è¿‡è¿ç§»"
          fi

      - name: Run tests
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          JWT_SECRET_KEY: test-secret-key-for-ci
          PYTHONPATH: .
        run: |
          echo "=== è¿è¡Œåç«¯æµ‹è¯• ==="
          pip install pytest pytest-asyncio httpx pytest-cov
          
          # éªŒè¯åº”ç”¨å¯ä»¥æ­£å¸¸å¯¼å…¥
          echo "éªŒè¯åº”ç”¨å¯¼å…¥..."
          python -c "from app.main import app; print('âœ… åº”ç”¨å¯ä»¥æ­£å¸¸å¯¼å…¥')" || exit 1
          
          # éªŒè¯æ‰€æœ‰å…³é”®æ¨¡å—å¯ä»¥å¯¼å…¥
          echo "éªŒè¯å…³é”®æ¨¡å—å¯¼å…¥..."
          python -c "
          from app.database import engine, SessionLocal
          from app.models import User, Task, Policy, BackupRecord
          from app.services import TaskService, AuthService, PolicyService, BackupService
          print('âœ… æ‰€æœ‰å…³é”®æ¨¡å—å¯¼å…¥æˆåŠŸ')
          " || exit 1
          
          # éªŒè¯æ•°æ®åº“è¿æ¥
          echo "éªŒè¯æ•°æ®åº“è¿æ¥..."
          python -c "
          from app.database import engine
          from sqlalchemy import text
          with engine.connect() as conn:
              result = conn.execute(text('SELECT 1'))
              assert result.fetchone()[0] == 1
              print('âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸')
          " || exit 1
          
          # è¿è¡Œpytestæµ‹è¯•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [ -f "pytest.ini" ] || [ -d "tests" ] || [ -f "test_*.py" ]; then
            echo "å‘ç°æµ‹è¯•æ–‡ä»¶ï¼Œè¿è¡Œpytest..."
            pytest -v --tb=short --cov=app --cov-report=term-missing || exit 1
          else
            echo "âš ï¸ æœªæ‰¾åˆ°pytestæµ‹è¯•æ–‡ä»¶ï¼Œä½†åŸºç¡€éªŒè¯å·²é€šè¿‡"
          fi
          
          # éªŒè¯APIè·¯ç”±æ³¨å†Œ
          echo "éªŒè¯APIè·¯ç”±..."
          python -c "
          from app.main import app
          routes = [r.path for r in app.routes]
          required_routes = ['/api/health', '/api/auth/login', '/api/tasks/', '/api/policies/']
          for route in required_routes:
              if any(route in r for r in routes):
                  print(f'âœ… è·¯ç”± {route} å·²æ³¨å†Œ')
              else:
                  print(f'âš ï¸ è·¯ç”± {route} æœªæ‰¾åˆ°')
          print('âœ… APIè·¯ç”±éªŒè¯å®Œæˆ')
          " || exit 1
          
          echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡"

      - name: Check code quality
        working-directory: ./backend
        run: |
          echo "=== ä»£ç è´¨é‡æ£€æŸ¥ ==="
          pip install flake8 black mypy pylint
          
          # è¯­æ³•é”™è¯¯æ£€æŸ¥ï¼ˆå¼ºåˆ¶ï¼Œä¸å…è®¸å¤±è´¥ï¼‰
          echo "æ£€æŸ¥Pythonè¯­æ³•é”™è¯¯..."
          python -m py_compile app/main.py app/config.py || exit 1
          find app -name "*.py" -exec python -m py_compile {} \; || exit 1
          echo "âœ… è¯­æ³•æ£€æŸ¥é€šè¿‡"
          
          # ä»£ç æ ¼å¼æ£€æŸ¥ï¼ˆå¼ºåˆ¶ï¼‰
          echo "æ£€æŸ¥ä»£ç æ ¼å¼ï¼ˆBlackï¼‰..."
          if ! black --check . 2>&1; then
            echo "âŒ ä»£ç æ ¼å¼ä¸ç¬¦åˆBlackè§„èŒƒ"
            echo ""
            echo "è¯·è¿è¡Œä»¥ä¸‹å‘½ä»¤æ ¼å¼åŒ–ä»£ç ï¼š"
            echo "  cd backend"
            echo "  black ."
            echo ""
            echo "æˆ–è€…æŸ¥çœ‹éœ€è¦æ ¼å¼åŒ–çš„æ–‡ä»¶ï¼š"
            black --check --diff . 2>&1 | head -50 || true
            echo ""
            echo "ï¼ˆæ˜¾ç¤ºå‰50è¡Œå·®å¼‚ï¼Œå®Œæ•´å·®å¼‚è¯·è¿è¡Œ: black --check --diff .ï¼‰"
            exit 1
          fi
          echo "âœ… ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"
          
          # Flake8æ£€æŸ¥ï¼ˆå¼ºåˆ¶å…³é”®é”™è¯¯ï¼‰
          echo "æ£€æŸ¥ä»£ç è´¨é‡ï¼ˆFlake8ï¼‰..."
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --max-line-length=120 --exclude=__pycache__,migrations || exit 1
          echo "âœ… Flake8å…³é”®é”™è¯¯æ£€æŸ¥é€šè¿‡"
          
          # ç±»å‹æ£€æŸ¥ï¼ˆè­¦å‘Šä½†ä¸é˜»å¡ï¼‰
          echo "æ£€æŸ¥ç±»å‹æ³¨è§£ï¼ˆMyPyï¼‰..."
          mypy app --ignore-missing-imports --no-strict-optional --show-error-codes || echo "âš ï¸ ç±»å‹æ£€æŸ¥æœ‰è­¦å‘Šï¼ˆéé˜»å¡ï¼‰"
          
          # è¿è¡Œè‡ªå®šä¹‰ç±»å‹æ£€æŸ¥è„šæœ¬
          echo "è¿è¡Œè‡ªå®šä¹‰ç±»å‹æ£€æŸ¥..."
          python check_types.py app --exclude __pycache__ migrations tests --summary || echo "âš ï¸ è‡ªå®šä¹‰ç±»å‹æ£€æŸ¥å‘ç°é—®é¢˜ï¼ˆéé˜»å¡ï¼‰"
          
          # æ£€æŸ¥å¯¼å…¥ä¾èµ–
          echo "éªŒè¯ä¾èµ–å¯¼å…¥..."
          python -c "
          import sys
          # æ¨¡å—åæ˜ å°„ï¼šå®‰è£…åŒ…å -> å¯¼å…¥å
          required_modules = {
              'fastapi': 'fastapi',
              'sqlalchemy': 'sqlalchemy',
              'pydantic': 'pydantic',
              'alembic': 'alembic',
              'python-docx': 'docx',  # python-docx å®‰è£…åå¯¼å…¥åä¸º docx
              'aiosmtplib': 'aiosmtplib'
          }
          missing = []
          for package_name, import_name in required_modules.items():
              try:
                  __import__(import_name)
              except ImportError:
                  missing.append(package_name)
          if missing:
              print(f'âŒ ç¼ºå°‘ä¾èµ–: {missing}')
              sys.exit(1)
          print('âœ… æ‰€æœ‰ä¾èµ–å·²å®‰è£…')
          " || exit 1
          
          echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆ"

  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend
        run: |
          npm ci --legacy-peer-deps || \
          (echo "npm ci å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ npm install..." && npm install --legacy-peer-deps)

      - name: Run linter
        working-directory: ./frontend
        run: |
          echo "=== è¿è¡Œå‰ç«¯ä»£ç æ£€æŸ¥ ==="
          npm run lint || exit 1
          echo "âœ… ä»£ç æ£€æŸ¥é€šè¿‡"

      - name: Build frontend
        working-directory: ./frontend
        env:
          VITE_API_BASE_URL: ""  # ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ç©ºå­—ç¬¦ä¸²ï¼ˆç›¸å¯¹è·¯å¾„ï¼‰
        run: |
          echo "=== æ„å»ºå‰ç«¯åº”ç”¨ ==="
          
          # éªŒè¯TypeScriptç¼–è¯‘
          echo "éªŒè¯TypeScriptç¼–è¯‘..."
          npm run build || exit 1
          
          # éªŒè¯æ„å»ºäº§ç‰©
          if [ ! -d "dist" ]; then
            echo "âŒ æ„å»ºå¤±è´¥ï¼Œdist ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          echo "âœ… æ„å»ºæˆåŠŸï¼Œdist ç›®å½•å·²åˆ›å»º"
          
          # æ£€æŸ¥å…³é”®æ–‡ä»¶
          echo "éªŒè¯æ„å»ºäº§ç‰©..."
          [ -f "dist/index.html" ] || (echo "âŒ index.html ä¸å­˜åœ¨" && exit 1)
          
          # æ£€æŸ¥JavaScriptæ–‡ä»¶ï¼ˆä½¿ç”¨lsæ¥æŸ¥æ‰¾åŒ¹é…çš„æ–‡ä»¶ï¼‰
          JS_FILES=$(ls dist/assets/*.js 2>/dev/null | head -1)
          if [ -z "$JS_FILES" ]; then
            echo "âŒ JavaScriptæ–‡ä»¶ä¸å­˜åœ¨"
            echo "dist/assets ç›®å½•å†…å®¹ï¼š"
            ls -la dist/assets/ 2>/dev/null || echo "dist/assets ç›®å½•ä¸å­˜åœ¨"
            exit 1
          else
            echo "âœ… æ‰¾åˆ°JavaScriptæ–‡ä»¶: $(echo $JS_FILES | xargs basename)"
          fi
          
          # æ£€æŸ¥CSSæ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
          CSS_FILES=$(ls dist/assets/*.css 2>/dev/null | head -1)
          if [ -z "$CSS_FILES" ]; then
            echo "âš ï¸ CSSæ–‡ä»¶å¯èƒ½ä¸å­˜åœ¨ï¼ˆå¦‚æœä½¿ç”¨å†…è”æ ·å¼ï¼‰"
          else
            echo "âœ… æ‰¾åˆ°CSSæ–‡ä»¶: $(echo $CSS_FILES | xargs basename)"
          fi
          
          # éªŒè¯index.htmlå†…å®¹
          echo "éªŒè¯index.htmlå†…å®¹..."
          grep -q "<!DOCTYPE html>" dist/index.html || (echo "âŒ index.htmlæ ¼å¼é”™è¯¯" && exit 1)
          grep -q "id=\"app\"" dist/index.html || (echo "âŒ Vueåº”ç”¨æ ¹å…ƒç´ ä¸å­˜åœ¨" && exit 1)
          
          # æ£€æŸ¥é™æ€èµ„æº
          echo "æ£€æŸ¥é™æ€èµ„æº..."
          if [ -d "dist/assets" ]; then
            ASSET_COUNT=$(ls -1 dist/assets/*.js 2>/dev/null | wc -l)
            if [ "$ASSET_COUNT" -eq 0 ]; then
              echo "âŒ æ²¡æœ‰æ‰¾åˆ°JavaScriptèµ„æºæ–‡ä»¶"
              exit 1
            fi
            echo "âœ… æ‰¾åˆ° $ASSET_COUNT ä¸ªJavaScriptèµ„æºæ–‡ä»¶"
          fi
          
          # éªŒè¯ç¯å¢ƒå˜é‡æ³¨å…¥
          echo "éªŒè¯ç¯å¢ƒå˜é‡..."
          if grep -q "VITE_API_BASE_URL" dist/index.html 2>/dev/null || grep -q "/api" dist/assets/*.js 2>/dev/null; then
            echo "âœ… APIé…ç½®å·²æ­£ç¡®æ³¨å…¥"
          else
            echo "âš ï¸ æœªæ£€æµ‹åˆ°APIé…ç½®ï¼ˆå¯èƒ½ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼‰"
          fi
          
          # æ˜¾ç¤ºæ„å»ºç»Ÿè®¡
          echo "=== æ„å»ºç»Ÿè®¡ ==="
          du -sh dist/
          find dist -type f | wc -l | xargs echo "æ–‡ä»¶æ€»æ•°:"
          ls -lah dist/ | head -15
          
          echo "âœ… æ„å»ºéªŒè¯é€šè¿‡"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-and-push
    permissions:
      contents: read
      security-events: write
      actions: read
      packages: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # ä¸é˜»å¡æ„å»ºï¼Œä»…æŠ¥å‘Š

      - name: Determine image tags
        id: image-tags
        run: |
          # æ ¹æ®äº‹ä»¶ç±»å‹ç¡®å®šå¯èƒ½çš„é•œåƒæ ‡ç­¾
          TAGS=""
          
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            TAGS="pr-${{ github.event.pull_request.number }} pr-${{ github.event.pull_request.number }}-${{ github.sha }}"
          elif [ "${{ github.event_name }}" == "release" ]; then
            TAGS="${{ github.event.release.tag_name }} latest"
          elif [ "${{ github.ref }}" == "refs/heads/main" ] || [ "${{ github.ref }}" == "refs/heads/master" ]; then
            TAGS="latest main-${{ github.sha }} master-${{ github.sha }}"
          else
            BRANCH_NAME=$(echo "${{ github.ref }}" | sed 's/refs\/heads\///' | sed 's/\//-/g')
            TAGS="${BRANCH_NAME} ${BRANCH_NAME}-${{ github.sha }}"
          fi
          
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "å¯èƒ½çš„é•œåƒæ ‡ç­¾: ${TAGS}"

      - name: Check if backend image exists
        id: check-backend-image
        continue-on-error: true
        run: |
          # å°è¯•å¤šä¸ªå¯èƒ½çš„æ ‡ç­¾
          TAGS='${{ steps.image-tags.outputs.tags }}'
          BASE_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/mnr-law-crawler-online-backend"
          
          echo "å°è¯•æŸ¥æ‰¾åç«¯é•œåƒ..."
          FOUND_IMAGE=""
          FOUND_TAG=""
          
          # éå†æ ‡ç­¾åˆ—è¡¨
          for TAG in ${TAGS}; do
            IMAGE_NAME="${BASE_IMAGE}:${TAG}"
            echo "æ£€æŸ¥: ${IMAGE_NAME}"
            
            if docker manifest inspect "${IMAGE_NAME}" >/dev/null 2>&1; then
              FOUND_IMAGE="${IMAGE_NAME}"
              FOUND_TAG="${TAG}"
              echo "âœ… æ‰¾åˆ°é•œåƒ: ${IMAGE_NAME}"
              break
            fi
          done
          
          if [ -n "${FOUND_IMAGE}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "image=${FOUND_IMAGE}" >> $GITHUB_OUTPUT
            echo "tag=${FOUND_TAG}" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ æœªæ‰¾åˆ°åç«¯é•œåƒï¼Œè·³è¿‡æ‰«æ"
            echo "å°è¯•çš„æ ‡ç­¾: ${TAGS}"
          fi

      - name: Scan backend Docker image
        if: steps.check-backend-image.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.check-backend-image.outputs.image }}
          format: 'sarif'
          output: 'trivy-backend-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Check if frontend image exists
        id: check-frontend-image
        continue-on-error: true
        run: |
          # å°è¯•å¤šä¸ªå¯èƒ½çš„æ ‡ç­¾
          TAGS='${{ steps.image-tags.outputs.tags }}'
          BASE_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/mnr-law-crawler-online-frontend"
          
          echo "å°è¯•æŸ¥æ‰¾å‰ç«¯é•œåƒ..."
          FOUND_IMAGE=""
          FOUND_TAG=""
          
          # éå†æ ‡ç­¾åˆ—è¡¨
          for TAG in ${TAGS}; do
            IMAGE_NAME="${BASE_IMAGE}:${TAG}"
            echo "æ£€æŸ¥: ${IMAGE_NAME}"
            
            if docker manifest inspect "${IMAGE_NAME}" >/dev/null 2>&1; then
              FOUND_IMAGE="${IMAGE_NAME}"
              FOUND_TAG="${TAG}"
              echo "âœ… æ‰¾åˆ°å‰ç«¯é•œåƒ: ${IMAGE_NAME}"
              break
            fi
          done
          
          if [ -n "${FOUND_IMAGE}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "image=${FOUND_IMAGE}" >> $GITHUB_OUTPUT
            echo "tag=${FOUND_TAG}" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ æœªæ‰¾åˆ°å‰ç«¯é•œåƒï¼Œè·³è¿‡æ‰«æ"
          fi

      - name: Scan frontend Docker image
        if: steps.check-frontend-image.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ${{ steps.check-frontend-image.outputs.image }}
          format: 'sarif'
          output: 'trivy-frontend-results.sarif'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Upload Trivy filesystem results
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-fs-results.sarif'

      - name: Upload Trivy backend image results
        uses: github/codeql-action/upload-sarif@v4
        if: always() && steps.check-backend-image.outputs.exists == 'true'
        with:
          sarif_file: 'trivy-backend-results.sarif'

      - name: Upload Trivy frontend image results
        uses: github/codeql-action/upload-sarif@v4
        if: always() && steps.check-frontend-image.outputs.exists == 'true'
        with:
          sarif_file: 'trivy-frontend-results.sarif'

      - name: Security scan summary
        if: always()
        run: |
          echo "=== å®‰å…¨æ‰«ææ‘˜è¦ ==="
          echo ""
          
          if [ -f "trivy-fs-results.sarif" ]; then
            echo "âœ… æ–‡ä»¶ç³»ç»Ÿæ‰«æå®Œæˆ"
          else
            echo "âš ï¸ æ–‡ä»¶ç³»ç»Ÿæ‰«ææœªå®Œæˆ"
          fi
          
          if [ -f "trivy-backend-results.sarif" ]; then
            echo "âœ… åç«¯ Docker é•œåƒæ‰«æå®Œæˆ"
          else
            echo "âš ï¸ åç«¯é•œåƒæ‰«ææœªå®Œæˆï¼ˆé•œåƒå¯èƒ½ä¸å­˜åœ¨æˆ–ä½¿ç”¨ä¸åŒæ ‡ç­¾ï¼‰"
          fi
          
          if [ -f "trivy-frontend-results.sarif" ]; then
            echo "âœ… å‰ç«¯ Docker é•œåƒæ‰«æå®Œæˆ"
          else
            echo "âš ï¸ å‰ç«¯é•œåƒæ‰«ææœªå®Œæˆï¼ˆé•œåƒå¯èƒ½ä¸å­˜åœ¨æˆ–ä½¿ç”¨ä¸åŒæ ‡ç­¾ï¼‰"
          fi
          
          echo ""
          echo "è¯¦ç»†ç»“æœå·²ä¸Šä¼ åˆ° GitHub Securityï¼ˆå¦‚æœå¯ç”¨ï¼‰"

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-and-push, test-backend, test-frontend]
    if: github.event_name == 'release' && github.event.action == 'published'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Generate release notes
        id: release_notes
        run: |
          echo "## ğŸ³ Docker Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ä»¥ä¸‹é•œåƒå·²æ„å»ºå¹¶æ¨é€åˆ° GitHub Container Registry:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/mnr-law-crawler-online-backend:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/mnr-law-crawler-online-frontend:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/mnr-law-crawler-online-db:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“¦ ä½¿ç”¨æ–¹å¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# æ‹‰å–é•œåƒ" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/mnr-law-crawler-online-backend:latest" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/mnr-law-crawler-online-frontend:latest" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/mnr-law-crawler-online-db:latest" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
